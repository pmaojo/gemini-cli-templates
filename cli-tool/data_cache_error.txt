
> gemini-cli-templates@1.28.12 test
> jest tests/unit/DataCache.test.js

FAIL tests/unit/DataCache.test.js
  DataCache
    constructor
      ✓ should initialize with empty caches and metrics (3 ms)
      ✓ should configure correctly (1 ms)
    getFileContent
      ✕ should read file when not cached (1 ms)
      ✕ should return cached content when file unchanged (1 ms)
      ✕ should re-read file when modified
      ✕ should handle file read errors
    getParsedConversation
      ✕ should parse conversation content correctly (1 ms)
      ✕ should cache parsed results (1 ms)
      ✕ should handle malformed JSON lines (1 ms)
    getCachedTokenUsage
      ✕ should compute and cache token usage
      ✕ should return cached result on subsequent calls
    invalidateFile
      ✓ should remove all cache entries for a file (1 ms)
    evictOldEntries
      ✓ should remove expired cache entries (2 ms)
    getStats
      ✕ should return cache statistics
      ✕ should calculate hit rate correctly
    cleanup
      ✓ should clear all caches and reset metrics

  ● DataCache › getFileContent › should read file when not cached

    TypeError: fs.stat.mockResolvedValue is not a function

      62 |
      63 |     beforeEach(() => {
    > 64 |       fs.stat.mockResolvedValue(mockStats);
         |               ^
      65 |       fs.readFile.mockResolvedValue(mockContent);
      66 |     });
      67 |

      at Object.<anonymous> (tests/unit/DataCache.test.js:64:15)

  ● DataCache › getFileContent › should return cached content when file unchanged

    TypeError: fs.stat.mockResolvedValue is not a function

      62 |
      63 |     beforeEach(() => {
    > 64 |       fs.stat.mockResolvedValue(mockStats);
         |               ^
      65 |       fs.readFile.mockResolvedValue(mockContent);
      66 |     });
      67 |

      at Object.<anonymous> (tests/unit/DataCache.test.js:64:15)

  ● DataCache › getFileContent › should re-read file when modified

    TypeError: fs.stat.mockResolvedValue is not a function

      62 |
      63 |     beforeEach(() => {
    > 64 |       fs.stat.mockResolvedValue(mockStats);
         |               ^
      65 |       fs.readFile.mockResolvedValue(mockContent);
      66 |     });
      67 |

      at Object.<anonymous> (tests/unit/DataCache.test.js:64:15)

  ● DataCache › getFileContent › should handle file read errors

    TypeError: fs.stat.mockResolvedValue is not a function

      62 |
      63 |     beforeEach(() => {
    > 64 |       fs.stat.mockResolvedValue(mockStats);
         |               ^
      65 |       fs.readFile.mockResolvedValue(mockContent);
      66 |     });
      67 |

      at Object.<anonymous> (tests/unit/DataCache.test.js:64:15)

  ● DataCache › getParsedConversation › should parse conversation content correctly

    TypeError: fs.stat.mockResolvedValue is not a function

      125 |
      126 |     beforeEach(() => {
    > 127 |       fs.stat.mockResolvedValue(mockStats);
          |               ^
      128 |       fs.readFile.mockResolvedValue(mockContent);
      129 |     });
      130 |

      at Object.<anonymous> (tests/unit/DataCache.test.js:127:15)

  ● DataCache › getParsedConversation › should cache parsed results

    TypeError: fs.stat.mockResolvedValue is not a function

      125 |
      126 |     beforeEach(() => {
    > 127 |       fs.stat.mockResolvedValue(mockStats);
          |               ^
      128 |       fs.readFile.mockResolvedValue(mockContent);
      129 |     });
      130 |

      at Object.<anonymous> (tests/unit/DataCache.test.js:127:15)

  ● DataCache › getParsedConversation › should handle malformed JSON lines

    TypeError: fs.stat.mockResolvedValue is not a function

      125 |
      126 |     beforeEach(() => {
    > 127 |       fs.stat.mockResolvedValue(mockStats);
          |               ^
      128 |       fs.readFile.mockResolvedValue(mockContent);
      129 |     });
      130 |

      at Object.<anonymous> (tests/unit/DataCache.test.js:127:15)

  ● DataCache › getCachedTokenUsage › should compute and cache token usage

    TypeError: fs.stat.mockResolvedValue is not a function

      174 |
      175 |     beforeEach(() => {
    > 176 |       fs.stat.mockResolvedValue(mockStats);
          |               ^
      177 |     });
      178 |
      179 |     it('should compute and cache token usage', async () => {

      at Object.<anonymous> (tests/unit/DataCache.test.js:176:15)

  ● DataCache › getCachedTokenUsage › should return cached result on subsequent calls

    TypeError: fs.stat.mockResolvedValue is not a function

      174 |
      175 |     beforeEach(() => {
    > 176 |       fs.stat.mockResolvedValue(mockStats);
          |               ^
      177 |     });
      178 |
      179 |     it('should compute and cache token usage', async () => {

      at Object.<anonymous> (tests/unit/DataCache.test.js:176:15)

  ● DataCache › getStats › should return cache statistics

    TypeError: fs.stat.mockResolvedValue is not a function

      257 |     it('should return cache statistics', async () => {
      258 |       const mockStats = { mtime: { getTime: () => 1000 } };
    > 259 |       fs.stat.mockResolvedValue(mockStats);
          |               ^
      260 |       fs.readFile.mockResolvedValue('{}');
      261 |
      262 |       // Add some test data

      at Object.<anonymous> (tests/unit/DataCache.test.js:259:15)

  ● DataCache › getStats › should calculate hit rate correctly

    TypeError: fs.stat.mockResolvedValue is not a function

      278 |     it('should calculate hit rate correctly', async () => {
      279 |       const mockStats = { mtime: { getTime: () => 1000 } };
    > 280 |       fs.stat.mockResolvedValue(mockStats);
          |               ^
      281 |       fs.readFile.mockResolvedValue('{}');
      282 |
      283 |       // Generate some hits and misses

      at Object.<anonymous> (tests/unit/DataCache.test.js:280:15)

--------------------------|---------|----------|---------|---------|--------------------------------------------------------
File                      | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                      
--------------------------|---------|----------|---------|---------|--------------------------------------------------------
All files                 |    0.97 |     0.29 |    0.86 |    1.03 |                                                        
 analytics-web/components |       0 |        0 |       0 |       0 |                                                        
  ActivityHeatmap.js      |       0 |        0 |       0 |       0 | 7-782                                                  
  AgentAnalytics.js       |       0 |        0 |       0 |       0 | 7-709                                                  
  App.js                  |       0 |        0 |       0 |       0 | 7-440                                                  
  Charts.js               |       0 |        0 |       0 |       0 | 7-113                                                  
  ConversationTable.js    |       0 |        0 |       0 |       0 | 7-436                                                  
  DashboardPage.js        |       0 |        0 |       0 |       0 | 7-2289                                                 
  HeaderComponent.js      |       0 |        0 |       0 |       0 | 7-306                                                  
  SessionTimer.js         |       0 |        0 |       0 |       0 | 7-598                                                  
  Sidebar.js              |       0 |        0 |       0 |       0 | 7-187                                                  
  ToolDisplay.js          |       0 |        0 |       0 |       0 | 7-553                                                  
 analytics-web/services   |       0 |        0 |       0 |       0 |                                                        
  DataService.js          |       0 |        0 |       0 |       0 | 7-449                                                  
  StateService.js         |       0 |        0 |       0 |       0 | 7-284                                                  
  WebSocketService.js     |       0 |        0 |       0 |       0 | 7-534                                                  
 analytics/core           |       0 |        0 |       0 |       0 |                                                        
  AgentAnalyzer.js        |       0 |        0 |       0 |       0 | 5-355                                                  
  ConversationAnalyzer.js |       0 |        0 |       0 |       0 | 1-949                                                  
  FileWatcher.js          |       0 |        0 |       0 |       0 | 1-420                                                  
  ProcessDetector.js      |       0 |        0 |       0 |       0 | 1-280                                                  
  SessionAnalyzer.js      |       0 |        0 |       0 |       0 | 5-686                                                  
  StateCalculator.js      |       0 |        0 |       0 |       0 | 1-246                                                  
  YearInReview2025.js     |       0 |        0 |       0 |       0 | 1-983                                                  
 analytics/data           |   19.64 |     5.29 |      25 |   20.09 |                                                        
  DataCache.js            |   19.64 |     5.29 |      25 |   20.09 | 61-451,474-480,492-507,552-554,560-562,576-611,631-673 
 analytics/notifications  |       0 |        0 |       0 |       0 |                                                        
  NotificationManager.js  |       0 |        0 |       0 |       0 | 5-485                                                  
  WebSocketServer.js      |       0 |        0 |       0 |       0 | 5-526                                                  
 analytics/utils          |       0 |        0 |       0 |       0 |                                                        
  PerformanceMonitor.js   |       0 |        0 |       0 |       0 | 5-455                                                  
--------------------------|---------|----------|---------|---------|--------------------------------------------------------
Jest: "global" coverage threshold for statements (70%) not met: 1.41%
Jest: "global" coverage threshold for branches (70%) not met: 0.43%
Jest: "global" coverage threshold for lines (70%) not met: 1.49%
Jest: "global" coverage threshold for functions (70%) not met: 1.27%
Jest: "./src/analytics/core/" coverage threshold for statements (80%) not met: 0%
Jest: "./src/analytics/core/" coverage threshold for branches (80%) not met: 0%
Jest: "./src/analytics/core/" coverage threshold for lines (80%) not met: 0%
Jest: "./src/analytics/core/" coverage threshold for functions (80%) not met: 0%
Test Suites: 1 failed, 1 total
Tests:       11 failed, 5 passed, 16 total
Snapshots:   0 total
Time:        3.281 s
Ran all test suites matching tests/unit/DataCache.test.js.
