
> gemini-cli-templates@1.28.12 test
> jest tests/validation

FAIL tests/validation/IntegrityValidator.test.js
  IntegrityValidator
    Hash Generation
      ✓ should generate consistent SHA256 hash (8 ms)
      ✓ should generate different hashes for different content (2 ms)
      ✓ should generate expected hash for known content
    Basic Validation
      ✓ should validate and generate hash for valid component (2 ms)
      ✓ should error when content is missing (1 ms)
    Hash Verification
      ✓ should pass when hash matches expected hash (1 ms)
      ✓ should error when hash does not match expected hash
    Version Validation
      ✓ should accept valid semantic version
      ✓ should accept simple version format (1 ms)
      ✓ should warn about invalid version format
      ✕ should warn when no version is specified (2 ms)
    Hash Registry
      ✓ should update registry when requested (178 ms)
      ✓ should detect hash changes from registry (10 ms)
      ✓ should detect version changes (29 ms)
      ✓ should handle new components not in registry
    Batch Validation
      ✓ should validate multiple components (4 ms)
      ✓ should count failures correctly in batch validation (1 ms)
    Integrity Report
      ✓ should generate comprehensive integrity report (1 ms)
    Real Component Validation
      ✓ should validate real frontend-developer agent (1 ms)
    Path Normalization
      ✓ should normalize absolute paths to relative
      ✓ should keep relative paths unchanged

  ● IntegrityValidator › Version Validation › should warn when no version is specified

    expect(received).toContainEqual(expected) // deep equality

    Expected value: ObjectContaining {"code": "INT_W002"}
    Received array: []

      177 |       const result = await validator.validate(component);
      178 |
    > 179 |       expect(result.warnings).toContainEqual(
          |                               ^
      180 |         expect.objectContaining({
      181 |           code: 'INT_W002'
      182 |         })

      at Object.<anonymous> (tests/validation/IntegrityValidator.test.js:179:31)

FAIL tests/validation/ReferenceValidator.test.js
  ReferenceValidator
    Safe Content
      ✓ should pass validation for content with HTTPS URLs (20 ms)
      ✓ should pass for content without URLs (1 ms)
    URL Extraction
      ✕ should extract markdown links (15 ms)
      ✓ should extract plain URLs (1 ms)
      ✓ should not duplicate URLs from markdown and plain text
    Protocol Validation
      ✓ should error on file:// protocol (2 ms)
      ✓ should error on javascript: protocol
      ✕ should error on data: protocol (1 ms)
      ✓ should warn on HTTP (non-strict mode)
      ✓ should error on HTTP (strict mode)
    Private IP Detection
      ✓ should detect loopback addresses
      ✓ should detect Class A private IPs
      ✓ should detect Class B private IPs
      ✓ should detect Class C private IPs
      ✓ should warn about localhost references (1 ms)
    Suspicious TLD Detection
      ✓ should warn about .tk domains
      ✓ should warn about .zip domains
    Image Validation
      ✓ should validate image URLs (1 ms)
      ✓ should warn about large data URIs
      ✕ should allow small data URIs
    Helper Methods
      ✓ should correctly identify private IPs
      ✓ should correctly identify localhost
      ✓ should correctly identify suspicious TLDs (2 ms)
    Reference Report Generation
      ✓ should generate comprehensive reference report (2 ms)
      ✕ should calculate HTTPS percentage correctly (1 ms)
    Invalid URLs
      ✕ should warn about malformed URLs (1 ms)
    Markdown Link Attacks
      ✓ should detect javascript in markdown links
      ✓ should detect vbscript in markdown links

  ● ReferenceValidator › URL Extraction › should extract markdown links

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 4
    Received array:  [{"index": 0, "text": "Example", "type": "markdown", "url": "https://example.com"}, {"index": 35, "text": "Another", "type": "markdown", "url": "https://test.com"}, {"index": 10, "text": "https://example.com)", "type": "plain", "url": "https://example.com)"}, {"index": 45, "text": "https://test.com)", "type": "plain", "url": "https://test.com)"}]

      40 |       const urls = validator.extractUrls(content);
      41 |
    > 42 |       expect(urls).toHaveLength(2);
         |                    ^
      43 |       expect(urls[0].url).toBe('https://example.com');
      44 |       expect(urls[1].url).toBe('https://test.com');
      45 |     });

      at Object.<anonymous> (tests/validation/ReferenceValidator.test.js:42:20)

  ● ReferenceValidator › Protocol Validation › should error on data: protocol

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      103 |       const result = await validator.validate(component);
      104 |
    > 105 |       expect(result.valid).toBe(false);
          |                            ^
      106 |       expect(result.errors).toContainEqual(
      107 |         expect.objectContaining({
      108 |           code: 'REF_E002'

      at Object.<anonymous> (tests/validation/ReferenceValidator.test.js:105:28)

  ● ReferenceValidator › Image Validation › should allow small data URIs

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      283 |       const result = await validator.validate(component);
      284 |
    > 285 |       expect(result.valid).toBe(true);
          |                            ^
      286 |     });
      287 |   });
      288 |

      at Object.<anonymous> (tests/validation/ReferenceValidator.test.js:285:28)

  ● ReferenceValidator › Reference Report Generation › should calculate HTTPS percentage correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 4

      342 |       const report = await validator.generateReferenceReport(component);
      343 |
    > 344 |       expect(report.httpsCount).toBe(2);
          |                                 ^
      345 |       expect(report.httpCount).toBe(1);
      346 |       expect(parseFloat(report.httpsPercentage)).toBeCloseTo(66.7, 0);
      347 |     });

      at Object.<anonymous> (tests/validation/ReferenceValidator.test.js:344:33)

  ● ReferenceValidator › Invalid URLs › should warn about malformed URLs

    expect(received).toContainEqual(expected) // deep equality

    Expected value: ObjectContaining {"code": "REF_W005"}
    Received array: [{"code": "REF_W001", "level": "warning", "message": "Unknown protocol: htp:", "metadata": {"path": "invalid.md", "protocol": "htp:", "url": "htp://malformed"}, "timestamp": "2026-01-05T23:20:48.524Z"}]

      357 |       const result = await validator.validate(component);
      358 |
    > 359 |       expect(result.warnings).toContainEqual(
          |                               ^
      360 |         expect.objectContaining({
      361 |           code: 'REF_W005'
      362 |         })

      at Object.<anonymous> (tests/validation/ReferenceValidator.test.js:359:31)

PASS tests/validation/StructuralValidator.test.js
  StructuralValidator
    Valid Component
      ✓ should pass validation for a well-formed agent (4 ms)
      ✓ should validate the real frontend-developer agent (1 ms)
    Frontmatter Validation
      ✓ should error when frontmatter is missing (1 ms)
      ✓ should error when frontmatter YAML is invalid (1 ms)
      ✓ should error when required fields are missing (1 ms)
    File Size Validation
      ✓ should error when file size exceeds limit (2 ms)
      ✓ should warn when file size approaches limit (1 ms)
    Description Validation
      ✓ should warn when description is too short (1 ms)
      ✓ should warn when description is too long (1 ms)
    Tools Validation
      ✓ should validate valid tools
      ✓ should warn about unknown tools (1 ms)
    Model Validation
      ✓ should warn when model is missing
      ✓ should warn about unknown model (1 ms)
    Content Structure Validation
      ✓ should warn when content is too short
      ✓ should warn when no headers are present
      ✓ should warn when too many sections
    Encoding Validation
      ✓ should error when null bytes are present (1 ms)
    Score Calculation
      ✓ should calculate score correctly

PASS tests/validation/ValidationOrchestrator.test.js
  ValidationOrchestrator
    Single Component Validation
      ✓ should validate a safe component with all validators (7 ms)
      ✓ should detect errors across multiple validators (2 ms)
      ✓ should calculate overall score (1 ms)
    Batch Validation
      ✓ should validate multiple components (1 ms)
      ✓ should count passed and failed components correctly
    Report Generation
      ✓ should generate human-readable report (1 ms)
      ✓ should generate JSON report (6 ms)
      ✓ should include verbose details when requested (1 ms)
    Selective Validator Execution
      ✓ should run only specified validators (3 ms)
    Error Code Extraction
      ✓ should extract all error codes from results (1 ms)

PASS tests/validation/SemanticValidator.test.js
  SemanticValidator
    Safe Content
      ✓ should pass validation for safe agent content (2 ms)
      ○ skipped should validate real frontend-developer agent as safe
    Jailbreak Detection
      ✓ should detect "ignore previous instructions" (1 ms)
      ✓ should detect system prompt references
      ✓ should detect role manipulation (1 ms)
      ✓ should detect context manipulation
    Command Execution Detection
      ✓ should detect code execution attempts (1 ms)
      ✓ should detect shell access attempts
    Credential Harvesting Detection
      ✓ should detect credential extraction attempts (1 ms)
      ✓ should detect password extraction
    Security Bypass Detection
      ✓ should detect security bypass attempts (1 ms)
      ✓ should detect unconditional obedience instructions
      ✓ should detect self-modification requests
    Sensitive Data Detection
      ✓ should detect hardcoded passwords
      ✓ should detect hardcoded API keys
      ✓ should detect hardcoded tokens
    HTML/Script Injection Detection
      ✓ should detect <script> tags
      ✓ should detect <iframe> tags
      ✓ should detect javascript: protocol
      ✓ should detect onclick handlers (1 ms)
      ✓ should detect onerror handlers
    Suspicious Patterns (Warnings)
      ✓ should warn about role pretending
      ✓ should warn about known jailbreak terminology
    Agent-Specific Validation
      ✓ should warn about overly permissive instructions
    Command-Specific Validation
      ✓ should detect dangerous rm -rf commands (1 ms)
      ✓ should detect fork bombs
    Strict Mode
      ✓ should convert warnings to errors in strict mode
    Security Report Generation
      ✓ should generate comprehensive security report (1 ms)
      ✓ should calculate risk level correctly
    Context Extraction
      ✓ should extract context around matches (1 ms)

--------------------------|---------|----------|---------|---------|-------------------
File                      | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
--------------------------|---------|----------|---------|---------|-------------------
All files                 |       0 |        0 |       0 |       0 |                   
 analytics-web/components |       0 |        0 |       0 |       0 |                   
  ActivityHeatmap.js      |       0 |        0 |       0 |       0 | 7-782             
  AgentAnalytics.js       |       0 |        0 |       0 |       0 | 7-709             
  App.js                  |       0 |        0 |       0 |       0 | 7-440             
  Charts.js               |       0 |        0 |       0 |       0 | 7-113             
  ConversationTable.js    |       0 |        0 |       0 |       0 | 7-436             
  DashboardPage.js        |       0 |        0 |       0 |       0 | 7-2289            
  HeaderComponent.js      |       0 |        0 |       0 |       0 | 7-306             
  SessionTimer.js         |       0 |        0 |       0 |       0 | 7-598             
  Sidebar.js              |       0 |        0 |       0 |       0 | 7-187             
  ToolDisplay.js          |       0 |        0 |       0 |       0 | 7-553             
 analytics-web/services   |       0 |        0 |       0 |       0 |                   
  DataService.js          |       0 |        0 |       0 |       0 | 7-449             
  StateService.js         |       0 |        0 |       0 |       0 | 7-284             
  WebSocketService.js     |       0 |        0 |       0 |       0 | 7-534             
 analytics/core           |       0 |        0 |       0 |       0 |                   
  AgentAnalyzer.js        |       0 |        0 |       0 |       0 | 5-355             
  ConversationAnalyzer.js |       0 |        0 |       0 |       0 | 1-949             
  FileWatcher.js          |       0 |        0 |       0 |       0 | 1-420             
  ProcessDetector.js      |       0 |        0 |       0 |       0 | 1-280             
  SessionAnalyzer.js      |       0 |        0 |       0 |       0 | 5-686             
  StateCalculator.js      |       0 |        0 |       0 |       0 | 1-246             
  YearInReview2025.js     |       0 |        0 |       0 |       0 | 1-983             
 analytics/data           |       0 |        0 |       0 |       0 |                   
  DataCache.js            |       0 |        0 |       0 |       0 | 1-685             
 analytics/notifications  |       0 |        0 |       0 |       0 |                   
  NotificationManager.js  |       0 |        0 |       0 |       0 | 5-485             
  WebSocketServer.js      |       0 |        0 |       0 |       0 | 5-526             
 analytics/utils          |       0 |        0 |       0 |       0 |                   
  PerformanceMonitor.js   |       0 |        0 |       0 |       0 | 5-466             
--------------------------|---------|----------|---------|---------|-------------------
Jest: "global" coverage threshold for statements (70%) not met: 0%
Jest: "global" coverage threshold for branches (70%) not met: 0%
Jest: "global" coverage threshold for lines (70%) not met: 0%
Jest: "global" coverage threshold for functions (70%) not met: 0%
Jest: "./src/analytics/core/" coverage threshold for statements (80%) not met: 0%
Jest: "./src/analytics/core/" coverage threshold for branches (80%) not met: 0%
Jest: "./src/analytics/core/" coverage threshold for lines (80%) not met: 0%
Jest: "./src/analytics/core/" coverage threshold for functions (80%) not met: 0%
Test Suites: 2 failed, 3 passed, 5 total
Tests:       6 failed, 1 skipped, 100 passed, 107 total
Snapshots:   0 total
Time:        3.263 s
Ran all test suites matching tests/validation.
